# API Reference

## Command Line Interface

### `pe-compile`

Compile PolicyEngine variables into standalone calculators.

```bash
pe-compile [OPTIONS]
```

#### Options

| Option | Short | Required | Description |
|--------|-------|----------|-------------|
| `--country` | `-c` | Yes | Country code: `uk`, `us`, or `mock` |
| `--variables` | `-v` | Yes | Comma-separated list of variables |
| `--output` | `-o` | No | Output file path (stdout if not specified) |
| `--year` | `-y` | No | Tax year for parameter values (default: current) |
| `--dry-run` | | No | Show what would be compiled |
| `--strip-comments` | | No | Strip comments (default: True) |
| `--version` | | No | Show version |
| `--help` | | No | Show help |

#### Examples

```bash
# Basic usage
pe-compile -c uk -v income_tax -o calc.py

# Multiple variables
pe-compile -c uk -v income_tax,national_insurance,child_benefit

# Specific year
pe-compile -c uk -v income_tax --year 2023

# Dry run to see dependencies
pe-compile -c uk -v income_tax --dry-run
```

---

## Python API

### `CodeGenerator`

Main class for generating standalone calculators.

```python
from pe_compile import CodeGenerator

generator = CodeGenerator()
```

#### Methods

##### `add_input_variable(name, default_value=0, value_type=float)`

Add an input variable (user-provided value).

```python
generator.add_input_variable(
    name="employment_income",
    default_value=0,
    value_type=float,
)
```

##### `add_variable(name, formula_source, dependencies, is_input=False)`

Add a computed variable with its formula.

```python
generator.add_variable(
    name="taxable_income",
    formula_source='''
def formula(person, period):
    income = person("employment_income", period)
    return max(0, income - 12570)
''',
    dependencies=["employment_income"],
)
```

##### `add_parameter(path, value)`

Add a parameter with its value (frozen for specific year).

```python
generator.add_parameter("gov.hmrc.income_tax.rates.basic", 0.20)
```

##### `generate_module() -> str`

Generate the standalone Python module.

```python
code = generator.generate_module()
print(code)

# Execute it
namespace = {}
exec(code, namespace)
result = namespace["calculate"](employment_income=50000)
```

---

### `DependencyGraph`

Graph of variable dependencies for topological sorting.

```python
from pe_compile import DependencyGraph

graph = DependencyGraph()
graph.add_variable("b", dependencies=["a"], formula_source="...")
graph.add_variable("a", dependencies=[], formula_source="...")

# Get all dependencies of a variable
deps = graph.get_transitive_dependencies("b")  # {"a"}

# Sort in calculation order
order = graph.topological_sort(["b"])  # ["a", "b"]
```

---

### `extract_dependencies_from_formula(formula_source) -> Dependencies`

Parse a PolicyEngine formula to extract variable and parameter dependencies.

```python
from pe_compile import extract_dependencies_from_formula

deps = extract_dependencies_from_formula('''
def formula(person, period, parameters):
    income = person("employment_income", period)
    rate = parameters(period).gov.tax.rate
    return income * rate
''')

print(deps.variables)   # {"employment_income"}
print(deps.parameters)  # {"gov.tax.rate"}
```

---

### `inline_parameters(code, parameter_values) -> str`

Replace parameter references with constant values.

```python
from pe_compile import inline_parameters

code = "rate = parameters(period).gov.tax.rate"
values = {"gov.tax.rate": 0.20}

result = inline_parameters(code, values)
# "rate = 0.2"
```

---

## Generated Code Format

The generated module has this structure:

```python
"""
Standalone calculator compiled from PolicyEngine UK.

Generated by pe-compile v0.1.0
Year: 2024
Target variables: income_tax
Total variables: 5
Parameters: 3
"""

import numpy as np
from numpy import where, maximum, minimum, zeros, ones


def calculate(employment_income=0, ...):
    """
    Calculate all derived values from inputs.

    Returns:
        dict: All calculated values
    """
    results = {}

    # Store inputs
    results['employment_income'] = employment_income

    # Calculate taxable_income
    income = results['employment_income']
    taxable_income = max(0, income - 12570)
    results['taxable_income'] = taxable_income

    # Calculate income_tax
    taxable = results['taxable_income']
    income_tax = taxable * 0.2
    results['income_tax'] = income_tax

    return results
```

### Return Value

The `calculate()` function returns a dictionary with:
- All input variable values
- All computed variable values

```python
result = calculate(employment_income=50000)
# {
#     'employment_income': 50000,
#     'taxable_income': 37430,
#     'income_tax': 7486.0
# }
```
